# Betanet Bounty Delivery Makefile
# Integrates with existing AI Village infrastructure

.PHONY: build test lint fmt fuzz bench sbom clean help install-deps

# Default target
all: build test lint

# Build all crates
build:
	@echo "ğŸ”¨ Building Betanet workspace..."
	cargo build --all-features
	@echo "âœ… Build complete"

# Build optimized release
build-release:
	@echo "ğŸš€ Building optimized release..."
	cargo build --release --all-features
	@echo "âœ… Release build complete"

# Run all tests
test:
	@echo "ğŸ§ª Running tests..."
	cargo test --all-features
	@echo "âœ… Tests complete"

# Run tests with coverage
test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	cargo install cargo-tarpaulin || true
	cargo tarpaulin --all-features --out Html
	@echo "âœ… Coverage report generated in tarpaulin-report.html"

# Lint all code
lint:
	@echo "ğŸ” Running linter..."
	cargo clippy --all-features -- -D warnings
	@echo "âœ… Linting complete"

# Format all code
fmt:
	@echo "ğŸ¨ Formatting code..."
	cargo fmt --all
	@echo "âœ… Formatting complete"

# Check formatting
fmt-check:
	@echo "ğŸ” Checking code formatting..."
	cargo fmt --all -- --check

# Run fuzzing suite
fuzz:
	@echo "ğŸ¯ Running fuzzing suite..."
	@if [ -x ./tools/fuzz/fuzz-all.sh ]; then \
		./tools/fuzz/fuzz-all.sh; \
	else \
		echo "âŒ Fuzz script not executable. Run: chmod +x tools/fuzz/fuzz-all.sh"; \
	fi

# Run benchmarks
bench:
	@echo "ğŸ“Š Running benchmarks..."
	@if [ -x ./tools/bench/bench-all.sh ]; then \
		./tools/bench/bench-all.sh; \
	else \
		echo "âŒ Bench script not executable. Run: chmod +x tools/bench/bench-all.sh"; \
	fi

# Generate SBOM (Software Bill of Materials)
sbom:
	@echo "ğŸ“‹ Generating SBOM..."
	cargo run --bin betanet-linter -- sbom --directory . --output betanet-sbom.json
	@echo "âœ… SBOM generated: betanet-sbom.json"

# Build C FFI library
build-ffi:
	@echo "ğŸ”— Building C FFI library..."
	cd ffi/betanet-c && cargo build --release
	@echo "âœ… FFI library built"

# Build Python integration
build-python:
	@echo "ğŸ Building Python integration..."
	cd ffi/betanet-c && cargo build --release --features python-integration
	@echo "âœ… Python integration built"

# Run example echo server
run-echo-server:
	@echo "ğŸ—£ï¸ Starting echo server..."
	cargo run --example echo_server

# Run example echo client
run-echo-client:
	@echo "ğŸ“ Starting echo client..."
	cargo run --example echo_client

# Run integration tests with AI Village infrastructure
test-integration:
	@echo "ğŸ”— Running AI Village integration tests..."
	# Test Python bridge
	cd ffi/betanet-c/python && python betanet_bridge.py
	# Test C FFI
	cd ffi/betanet-c && cargo test
	@echo "âœ… Integration tests complete"

# Install development dependencies
install-deps:
	@echo "ğŸ“¦ Installing development dependencies..."
	cargo install cargo-fuzz || true
	cargo install cargo-tarpaulin || true
	cargo install cbindgen || true
	@echo "âœ… Dependencies installed"

# Security audit
audit:
	@echo "ğŸ”’ Running security audit..."
	cargo audit || (echo "Install with: cargo install cargo-audit" && false)
	@echo "âœ… Security audit complete"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean
	rm -rf target/
	rm -f betanet-sbom.json
	rm -f tarpaulin-report.html
	@echo "âœ… Clean complete"

# Check integration with existing AI Village components
check-aivillage-integration:
	@echo "ğŸ” Checking AI Village integration..."
	@echo "Checking for existing Betanet infrastructure..."
	@if [ -f "../src/core/p2p/betanet_transport_v2.py" ]; then \
		echo "âœ… Found existing Betanet transport v2"; \
	else \
		echo "âŒ Missing Betanet transport v2"; \
	fi
	@if [ -f "../src/core/p2p/dual_path_transport.py" ]; then \
		echo "âœ… Found dual-path transport"; \
	else \
		echo "âŒ Missing dual-path transport"; \
	fi
	@if [ -d "../platforms/rust/betanet" ]; then \
		echo "âœ… Found existing Rust Betanet components"; \
	else \
		echo "âŒ Missing existing Rust components"; \
	fi

# Comprehensive delivery check
delivery-check: build test lint audit sbom check-aivillage-integration
	@echo "ğŸ‰ Betanet bounty delivery check complete!"
	@echo "ğŸ“¦ Deliverables:"
	@echo "  - âœ… betanet-htx crate (TCP/QUIC transport with Noise-XK)"
	@echo "  - âœ… betanet-mixnode crate (Nym-style mixnode with Sphinx)"
	@echo "  - âœ… betanet-utls crate (Chrome N-2 fingerprint generator)"
	@echo "  - âœ… betanet-linter crate (spec compliance + SBOM)"
	@echo "  - âœ… C FFI library (betanet-c)"
	@echo "  - âœ… Python integration bridge"
	@echo "  - âœ… Fuzzing infrastructure"
	@echo "  - âœ… Benchmarking suite"
	@echo "  - âœ… Example programs"
	@echo "  - âœ… CI/CD pipeline"
	@echo "  - âœ… SBOM generation"
	@echo "  - âœ… AI Village integration"

# Help target
help:
	@echo "Betanet Bounty Delivery Makefile"
	@echo "================================="
	@echo ""
	@echo "Main targets:"
	@echo "  build              Build all crates"
	@echo "  build-release      Build optimized release"
	@echo "  test               Run all tests"
	@echo "  test-coverage      Run tests with coverage"
	@echo "  lint               Run clippy linter"
	@echo "  fmt                Format code"
	@echo "  fuzz               Run fuzzing suite"
	@echo "  bench              Run benchmarks"
	@echo "  sbom               Generate SBOM"
	@echo "  audit              Security audit"
	@echo ""
	@echo "Integration targets:"
	@echo "  build-ffi          Build C FFI library"
	@echo "  build-python       Build Python integration"
	@echo "  test-integration   Test AI Village integration"
	@echo "  check-aivillage-integration  Check for AI Village components"
	@echo ""
	@echo "Example targets:"
	@echo "  run-echo-server    Start echo server example"
	@echo "  run-echo-client    Start echo client example"
	@echo ""
	@echo "Utility targets:"
	@echo "  install-deps       Install development dependencies"
	@echo "  clean              Clean build artifacts"
	@echo "  delivery-check     Comprehensive delivery validation"
	@echo "  help               Show this help message"
