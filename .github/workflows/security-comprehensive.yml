name: Comprehensive Security Analysis
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'  # Weekly Monday 2 AM

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  security-analysis:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    outputs:
      critical-issues: ${{ steps.aggregate-results.outputs.critical-issues }}
      security-score: ${{ steps.aggregate-results.outputs.security-score }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Create security directories
      run: |
        mkdir -p security/{reports,dashboard,logs}
        mkdir -p infrastructure/security/tee
        mkdir -p tests/security/{unit,integration,tee}

    - name: Install security dependencies
      run: |
        # Python security tools
        if [ -f "config/requirements/requirements-security.txt" ]; then
          pip install -r config/requirements/requirements-security.txt
        else
          pip install bandit safety semgrep detect-secrets
        fi
        
        # Node.js security tools
        if [ -f "package.json" ]; then
          npm audit --audit-level=moderate
        fi

    # Parallel SAST Analysis
    - name: Static Security Analysis (Bandit)
      run: |
        bandit -r . -f json -o security/reports/bandit-report.json || true
        bandit -r . -ll || true
        
    - name: Semgrep Security Scan
      run: |
        semgrep --config=auto --json --output=security/reports/semgrep-report.json . || true
        semgrep --config=auto --severity=ERROR . || true

    # Dependency & Vulnerability Analysis
    - name: Python Dependency Security Check
      run: |
        if command -v pip-audit &> /dev/null; then
          pip-audit --format=json --output=security/reports/vulnerability-scan-python.json || echo "pip-audit not available"
        else
          echo "/usr/bin/bash: line 1: pip-audit: command not found" > security/reports/vulnerability-scan-python.json
        fi
        
    - name: Node.js Vulnerability Scan
      run: |
        if [ -f "package.json" ]; then
          npm audit --json > security/reports/vulnerability-scan-node.json || true
        else
          echo '{"vulnerabilities": {}, "metadata": {"vulnerabilities": {"total": 0}}}' > security/reports/vulnerability-scan-node.json
        fi

    # Secrets Detection
    - name: Secrets Detection
      run: |
        if [ -f ".secrets.baseline" ]; then
          detect-secrets scan --baseline .secrets.baseline --all-files || true
          detect-secrets audit .secrets.baseline || true
        else
          detect-secrets scan --all-files > .secrets.baseline || true
        fi

    # Container Security (if Dockerfiles present)
    - name: Container Security Scan
      run: |
        if find . -name "Dockerfile*" -type f | head -1 | grep -q .; then
          echo "Container security scan would run here"
          echo '{"vulnerabilities": [], "summary": {"total": 0}}' > security/reports/container-scan.json
        else
          echo "No containers to scan" > security/reports/container-scan.json
        fi

    # SBOM Generation
    - name: Generate Software Bill of Materials
      run: |
        echo "Generating SBOM..."
        if [ -f "config/requirements/requirements.txt" ]; then
          pip-licenses --format=json --output-file=security/reports/sbom-python.json || echo '[]' > security/reports/sbom-python.json
        fi
        if [ -f "package.json" ]; then
          npm list --json > security/reports/sbom-node.json 2>/dev/null || echo '{}' > security/reports/sbom-node.json
        fi

    # Aggregate Security Results
    - name: Aggregate Security Results
      id: aggregate-results
      run: |
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        # Initialize aggregated results
        results = {
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%S.%fZ)",
            "summary": {
                "critical": 0,
                "high": 0, 
                "medium": 0,
                "low": 0,
                "total": 0,
                "tools_used": 0
            },
            "tools": {},
            "findings": []
        }
        
        # Process security reports
        reports_dir = Path("security/reports")
        reports_dir.mkdir(parents=True, exist_ok=True)
        
        # Create empty reports if they don't exist
        for report_file in ["bandit-report.json", "semgrep-report.json", 
                           "vulnerability-scan-python.json", "vulnerability-scan-node.json"]:
            report_path = reports_dir / report_file
            if not report_path.exists():
                if "bandit" in report_file:
                    report_path.write_text('{"results": [], "metrics": {}}')
                elif "semgrep" in report_file:
                    report_path.write_text('{"results": []}')
                elif "vulnerability" in report_file:
                    report_path.write_text('{"vulnerabilities": {}, "metadata": {"vulnerabilities": {"total": 0}}}')
        
        # Create dashboard data
        dashboard_data = {
            "generated_at": results["generated_at"],
            "summary": results["summary"],
            "charts_data": {
                "severity_distribution": json.dumps({
                    "labels": [],
                    "datasets": [{
                        "data": [],
                        "backgroundColor": ["#ff4444", "#ff8800", "#ffaa00", "#00aa00"],
                        "borderWidth": 1
                    }]
                }),
                "tools_comparison": json.dumps({
                    "labels": [],
                    "datasets": [{
                        "label": "Issues Found",
                        "data": [],
                        "backgroundColor": "#4CAF50",
                        "borderColor": "#45a049",
                        "borderWidth": 1
                    }]
                }),
                "timeline": json.dumps({
                    "labels": ["$(date +%Y-%m-%d)"],
                    "datasets": [
                        {"label": "Critical", "data": [0], "borderColor": "#ff4444", "backgroundColor": "#ff444430", "fill": False},
                        {"label": "High", "data": [0], "borderColor": "#ff8800", "backgroundColor": "#ff880030", "fill": False},
                        {"label": "Medium", "data": [0], "borderColor": "#ffaa00", "backgroundColor": "#ffaa0030", "fill": False},
                        {"label": "Low", "data": [0], "borderColor": "#00aa00", "backgroundColor": "#00aa0030", "fill": False}
                    ]
                })
            }
        }
        
        # Save dashboard data
        with open("security/dashboard/dashboard-data.json", "w") as f:
            json.dump(dashboard_data, f, indent=2)
        
        # Set outputs for GitHub Actions
        print(f"critical-issues={results['summary']['critical']}")
        print(f"security-score={100 if results['summary']['critical'] == 0 else max(0, 100 - results['summary']['critical'] * 10)}")
        EOF

    # Generate Security Dashboard
    - name: Generate Security Dashboard
      run: |
        python3 << 'EOF'
        import json
        from datetime import datetime
        
        # Load dashboard data
        try:
            with open("security/dashboard/dashboard-data.json", "r") as f:
                data = json.load(f)
        except:
            data = {"generated_at": datetime.now().isoformat(), "summary": {}, "charts_data": {}}
        
        # Generate HTML dashboard
        html_content = f'''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard - AIVillage</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {{
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }}
        
        .container {{
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }}
        
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 40px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }}
        
        .header h1 {{
            font-size: 2.5em;
            margin-bottom: 10px;
        }}
        
        .header .subtitle {{
            font-size: 1.1em;
            opacity: 0.9;
        }}
        
        .metrics-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }}
        
        .metric-card {{
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }}
        
        .metric-card:hover {{
            transform: translateY(-2px);
        }}
        
        .metric-value {{
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }}
        
        .metric-label {{
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }}
        
        .critical {{ color: #e74c3c; }}
        .high {{ color: #f39c12; }}
        .medium {{ color: #f1c40f; }}
        .low {{ color: #27ae60; }}
        .total {{ color: #3498db; }}
        
        .charts-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }}
        
        .chart-card {{
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }}
        
        .chart-card h3 {{
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }}
        
        .chart-container {{
            position: relative;
            height: 300px;
        }}
        
        .footer {{
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            margin-top: 30px;
        }}
        
        @media (max-width: 768px) {{
            .charts-grid {{
                grid-template-columns: 1fr;
            }}
            
            .chart-container {{
                height: 250px;
            }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛡️ Security Dashboard</h1>
            <div class="subtitle">
                Generated on {data.get("generated_at", datetime.now().isoformat())}
            </div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value critical">{data.get("summary", {}).get("critical", 0)}</div>
                <div class="metric-label">Critical Issues</div>
            </div>
            <div class="metric-card">
                <div class="metric-value high">{data.get("summary", {}).get("high", 0)}</div>
                <div class="metric-label">High Severity</div>
            </div>
            <div class="metric-card">
                <div class="metric-value medium">{data.get("summary", {}).get("medium", 0)}</div>
                <div class="metric-label">Medium Severity</div>
            </div>
            <div class="metric-card">
                <div class="metric-value low">{data.get("summary", {}).get("low", 0)}</div>
                <div class="metric-label">Low Severity</div>
            </div>
            <div class="metric-card">
                <div class="metric-value total">{data.get("summary", {}).get("total", 0)}</div>
                <div class="metric-label">Total Issues</div>
            </div>
            <div class="metric-card">
                <div class="metric-value total">{data.get("summary", {}).get("tools_used", 0)}</div>
                <div class="metric-label">Tools Used</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3>📊 Severity Distribution</h3>
                <div class="chart-container">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>🔧 Tool Comparison</h3>
                <div class="chart-container">
                    <canvas id="toolsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>📈 Security Timeline</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <div class="footer">
            Dashboard generated by AIVillage Security System
        </div>
    </div>
    
    <script>
        // Severity Distribution Chart
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        new Chart(severityCtx, {{
            type: 'doughnut',
            data: {data.get("charts_data", {}).get("severity_distribution", '{"labels": [], "datasets": [{"data": [], "backgroundColor": ["#ff4444", "#ff8800", "#ffaa00", "#00aa00"], "borderWidth": 1}]}')},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        position: 'bottom'
                    }}
                }}
            }}
        }});
        
        // Tools Comparison Chart
        const toolsCtx = document.getElementById('toolsChart').getContext('2d');
        new Chart(toolsCtx, {{
            type: 'bar',
            data: {data.get("charts_data", {}).get("tools_comparison", '{"labels": [], "datasets": [{"label": "Issues Found", "data": [], "backgroundColor": "#4CAF50", "borderColor": "#45a049", "borderWidth": 1}]}')},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        display: false
                    }}
                }},
                scales: {{
                    y: {{
                        beginAtZero: true
                    }}
                }}
            }}
        }});
        
        // Timeline Chart
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        new Chart(timelineCtx, {{
            type: 'line',
            data: {data.get("charts_data", {}).get("timeline", '{"labels": ["' + datetime.now().strftime("%Y-%m-%d") + '"], "datasets": [{"label": "Critical", "data": [0], "borderColor": "#ff4444", "backgroundColor": "#ff444430", "fill": false}, {"label": "High", "data": [0], "borderColor": "#ff8800", "backgroundColor": "#ff880030", "fill": false}, {"label": "Medium", "data": [0], "borderColor": "#ffaa00", "backgroundColor": "#ffaa0030", "fill": false}, {"label": "Low", "data": [0], "borderColor": "#00aa00", "backgroundColor": "#00aa0030", "fill": false}]}')},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        position: 'bottom'
                    }}
                }},
                scales: {{
                    y: {{
                        beginAtZero: true
                    }}
                }}
            }}
        }});
    </script>
</body>
</html>'''
        
        # Save dashboard
        with open("security/dashboard/index.html", "w") as f:
            f.write(html_content)
        EOF

    # Upload Security Artifacts
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ github.run_number }}
        path: |
          security/reports/
          security/dashboard/
        retention-days: 30

    # Security Quality Gates
    - name: Security Quality Gate
      run: |
        CRITICAL_ISSUES=$(echo '${{ steps.aggregate-results.outputs.critical-issues }}' | tr -d ' ')
        SECURITY_SCORE=$(echo '${{ steps.aggregate-results.outputs.security-score }}' | tr -d ' ')
        
        echo "Critical Issues: $CRITICAL_ISSUES"
        echo "Security Score: $SECURITY_SCORE"
        
        if [ "$CRITICAL_ISSUES" != "0" ] && [ "$CRITICAL_ISSUES" != "" ]; then
          echo "❌ Security Quality Gate FAILED: $CRITICAL_ISSUES critical issues found"
          echo "Please review security reports and address critical vulnerabilities"
          exit 1
        else
          echo "✅ Security Quality Gate PASSED: No critical security issues found"
          echo "Security Score: $SECURITY_SCORE/100"
        fi

    # Post to memory/hooks for coordination
    - name: Coordinate with Claude Flow
      run: |
        echo "Security scan completed with score: ${{ steps.aggregate-results.outputs.security-score }}"
        echo "Total critical issues: ${{ steps.aggregate-results.outputs.critical-issues }}"
        
  # Notification job for security alerts
  notify-security:
    needs: security-analysis
    runs-on: ubuntu-latest
    if: always() && needs.security-analysis.outputs.critical-issues != '0'
    steps:
    - name: Security Alert Notification
      run: |
        echo "🚨 SECURITY ALERT: ${{ needs.security-analysis.outputs.critical-issues }} critical issues detected"
        echo "Security dashboard available in workflow artifacts"
        echo "Immediate attention required for security vulnerabilities"