name: Basic CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install ALL test dependencies
        pip install pytest pytest-asyncio pytest-cov pytest-mock
        pip install black ruff mypy
        # Install project dependencies
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f pyproject.toml ]; then pip install -e .; fi

    - name: Lint with Black
      run: |
        black --check src/ tests/
      # Fail fast on lint errors

    - name: Lint with Ruff
      run: |
        ruff check src/ tests/

    - name: Run Tests
      run: |
        # Create __init__.py files if missing
        touch src/__init__.py
        find src -type d -exec touch {}/__init__.py \;

        # Run tests with proper Python path
        export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing --cov-report=xml
      # Fail fast on test errors

    - name: Upload coverage
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
